"use client"

import { useEffect, useState, useCallback } from "react"
import { Command } from "lucide-react"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { useEngagementContext } from "@/contexts/engagement-context"
import { notification } from "@/components/ui/notification"
import type { Engagement } from "@/lib/types"

interface KeyboardShortcutsProps {
  onNewFinding: () => void
}

const shortcuts = [
  { keys: ["Alt", "P"], description: "Switch phase" },
  { keys: ["Alt", "N"], description: "New finding" },
  { keys: ["Escape"], description: "Close modal" },
  { keys: ["?"], description: "Show keyboard shortcuts" },
]

export function KeyboardShortcuts({
  onNewFinding,
}: KeyboardShortcutsProps) {
  const [showHelp, setShowHelp] = useState(false)
  const { activeEngagement, updateEngagement } = useEngagementContext()

  const onSwitchPhase = useCallback(async () => {
    if (!activeEngagement) {
      notification.error("No engagement selected")
      return
    }

    const phases: Engagement["phase"][] = [
      "reconnaissance",
      "enumeration",
      "exploitation",
      "post-exploitation",
      "reporting",
    ]
    const currentIndex = phases.indexOf(activeEngagement.phase)
    const nextIndex = (currentIndex + 1) % phases.length
    const nextPhase = phases[nextIndex]

    try {
      await updateEngagement(activeEngagement.id, { phase: nextPhase })
      notification.success("Phase updated", `Switched to ${nextPhase} phase`)
    } catch (error) {
      console.error("Failed to switch phase:", error)
      notification.error(
        "Failed to switch phase",
        error instanceof Error ? error.message : "An unknown error occurred"
      )
    }
  }, [activeEngagement, updateEngagement])

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Don't trigger shortcuts when typing in inputs
      if (
        e.target instanceof HTMLInputElement ||
        e.target instanceof HTMLTextAreaElement
      ) {
        // Allow Escape in inputs
        if (e.key === "Escape") {
          ;(e.target as HTMLElement).blur()
        }
        return
      }

      // Show help with ?
      if (e.key === "?" && !e.ctrlKey && !e.metaKey) {
        e.preventDefault()
        setShowHelp(true)
        return
      }

      // Ctrl/Cmd + key shortcuts
      if (e.altKey || e.metaKey) {
        switch (e.key.toLowerCase()) {
          case "p":
            if (!e.shiftKey) {
              e.preventDefault()
              onSwitchPhase()
            }
            break
        }
      }

      // Alt + key shortcuts
      if (e.altKey) {
        switch (e.key.toLowerCase()) {
          case "n":
            e.preventDefault()
            onNewFinding()
            break
        }
      }
    }

    window.addEventListener("keydown", handleKeyDown)
    return () => window.removeEventListener("keydown", handleKeyDown)
  }, [onSwitchPhase, onNewFinding])

  return (
    <>
      {/* Keyboard shortcuts indicator */}
      <button
        type="button"
        onClick={() => setShowHelp(true)}
        className="fixed bottom-4 right-4 flex items-center gap-1.5 rounded-md bg-card/80 px-2 py-1 text-xs text-muted-foreground backdrop-blur-sm transition-colors hover:bg-card hover:text-foreground"
      >
        <Command className="h-3 w-3" />
        <span>Press ? for shortcuts</span>
      </button>

      {/* Shortcuts dialog */}
      <Dialog open={showHelp} onOpenChange={setShowHelp}>
        <DialogContent className="bg-card sm:max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Command className="h-5 w-5" />
              Keyboard Shortcuts
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-2 py-4">
            {shortcuts.map((shortcut) => (
              <div
                key={shortcut.description}
                className="flex items-center justify-between rounded-md px-2 py-1.5 hover:bg-secondary"
              >
                <span className="text-sm">{shortcut.description}</span>
                <div className="flex items-center gap-1">
                  {shortcut.keys.map((key, index) => (
                    <span key={key}>
                      <kbd className="rounded bg-muted px-1.5 py-0.5 font-mono text-xs">
                        {key}
                      </kbd>
                      {index < shortcut.keys.length - 1 && (
                        <span className="mx-1 text-muted-foreground">+</span>
                      )}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
          <p className="text-xs text-muted-foreground">
            Pro tip: Use keyboard shortcuts to navigate faster and keep your hands on the keyboard.
          </p>
        </DialogContent>
      </Dialog>
    </>
  )
}
