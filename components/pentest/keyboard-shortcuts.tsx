"use client"

import { useEffect, useState } from "react"
import { Command } from "lucide-react"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"

interface KeyboardShortcutsProps {
  onSwitchPhase: () => void
  onNewFinding: () => void
  onFocusSuggestions: () => void
}

const shortcuts = [
  { keys: ["Ctrl", "P"], description: "Switch phase" },
  { keys: ["Ctrl", "N"], description: "New finding" },
  { keys: ["Ctrl", "S"], description: "Focus suggestions" },
  { keys: ["Ctrl", "C"], description: "Copy command (in drawer)" },
  { keys: ["Escape"], description: "Close drawer/modal" },
  { keys: ["?"], description: "Show keyboard shortcuts" },
]

export function KeyboardShortcuts({
  onSwitchPhase,
  onNewFinding,
  onFocusSuggestions,
}: KeyboardShortcutsProps) {
  const [showHelp, setShowHelp] = useState(false)

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      // Don't trigger shortcuts when typing in inputs
      if (
        e.target instanceof HTMLInputElement ||
        e.target instanceof HTMLTextAreaElement
      ) {
        // Allow Escape in inputs
        if (e.key === "Escape") {
          ;(e.target as HTMLElement).blur()
        }
        return
      }

      // Show help with ?
      if (e.key === "?" && !e.ctrlKey && !e.metaKey) {
        e.preventDefault()
        setShowHelp(true)
        return
      }

      // Ctrl/Cmd + key shortcuts
      if (e.ctrlKey || e.metaKey) {
        switch (e.key.toLowerCase()) {
          case "p":
            e.preventDefault()
            onSwitchPhase()
            break
          case "n":
            e.preventDefault()
            onNewFinding()
            break
          case "s":
            e.preventDefault()
            onFocusSuggestions()
            break
        }
      }
    }

    window.addEventListener("keydown", handleKeyDown)
    return () => window.removeEventListener("keydown", handleKeyDown)
  }, [onSwitchPhase, onNewFinding, onFocusSuggestions])

  return (
    <>
      {/* Keyboard shortcuts indicator */}
      <button
        type="button"
        onClick={() => setShowHelp(true)}
        className="fixed bottom-4 right-4 flex items-center gap-1.5 rounded-md bg-card/80 px-2 py-1 text-xs text-muted-foreground backdrop-blur-sm transition-colors hover:bg-card hover:text-foreground"
      >
        <Command className="h-3 w-3" />
        <span>Press ? for shortcuts</span>
      </button>

      {/* Shortcuts dialog */}
      <Dialog open={showHelp} onOpenChange={setShowHelp}>
        <DialogContent className="bg-card sm:max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Command className="h-5 w-5" />
              Keyboard Shortcuts
            </DialogTitle>
          </DialogHeader>
          <div className="space-y-2 py-4">
            {shortcuts.map((shortcut) => (
              <div
                key={shortcut.description}
                className="flex items-center justify-between rounded-md px-2 py-1.5 hover:bg-secondary"
              >
                <span className="text-sm">{shortcut.description}</span>
                <div className="flex items-center gap-1">
                  {shortcut.keys.map((key, index) => (
                    <span key={key}>
                      <kbd className="rounded bg-muted px-1.5 py-0.5 font-mono text-xs">
                        {key}
                      </kbd>
                      {index < shortcut.keys.length - 1 && (
                        <span className="mx-1 text-muted-foreground">+</span>
                      )}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
          <p className="text-xs text-muted-foreground">
            Pro tip: Use keyboard shortcuts to navigate faster and keep your hands on the keyboard.
          </p>
        </DialogContent>
      </Dialog>
    </>
  )
}
