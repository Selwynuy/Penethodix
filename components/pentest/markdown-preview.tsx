"use client"

import { useEffect } from "react"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"
import { ScrollArea } from "@/components/ui/scroll-area"
import { X } from "lucide-react"

interface MarkdownPreviewProps {
  content: string
  open: boolean
  onOpenChange: (open: boolean) => void
}

// Simple markdown renderer (basic implementation)
// Note: For production, consider using a proper markdown library like marked or remark
function renderMarkdown(content: string): string {
  if (!content) return ""
  
  // Escape HTML to prevent XSS (server-safe)
  const escapeHtml = (text: string): string => {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;')
  }
  
  let html = content
  
  // Code blocks first (before other processing)
  html = html.replace(/```([\s\S]*?)```/g, (match, code) => {
    const escaped = escapeHtml(code.trim())
    return `<pre class="bg-muted p-3 rounded-md my-2 overflow-x-auto"><code class="font-mono text-sm">${escaped}</code></pre>`
  })
  
  // Headers
  html = html.replace(/^### (.*$)/gim, (match, text) => `<h3 class="text-lg font-semibold mt-4 mb-2">${escapeHtml(text)}</h3>`)
  html = html.replace(/^## (.*$)/gim, (match, text) => `<h2 class="text-xl font-semibold mt-6 mb-3">${escapeHtml(text)}</h2>`)
  html = html.replace(/^# (.*$)/gim, (match, text) => `<h1 class="text-2xl font-bold mt-8 mb-4">${escapeHtml(text)}</h1>`)
  
  // Bold (after code blocks to avoid conflicts)
  html = html.replace(/\*\*(.*?)\*\*/g, (match, text) => `<strong class="font-semibold">${escapeHtml(text)}</strong>`)
  
  // Italic (avoid conflicts with bold)
  html = html.replace(/(?<!\*)\*([^*\n]+?)\*(?!\*)/g, (match, text) => `<em class="italic">${escapeHtml(text)}</em>`)
  
  // Inline code (after bold/italic)
  html = html.replace(/`([^`]+)`/g, (match, code) => `<code class="bg-muted px-1 py-0.5 rounded font-mono text-sm">${escapeHtml(code)}</code>`)
  
  // Links (sanitize URLs)
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
    const safeUrl = url.startsWith('http://') || url.startsWith('https://') || url.startsWith('mailto:') 
      ? escapeHtml(url)
      : '#'
    return `<a href="${safeUrl}" class="text-primary hover:underline" target="_blank" rel="noopener noreferrer">${escapeHtml(text)}</a>`
  })
  
  // Lists
  html = html.replace(/^\- (.*$)/gim, (match, text) => `<li class="ml-4">${escapeHtml(text)}</li>`)
  html = html.replace(/(<li.*<\/li>)/gms, '<ul class="list-disc my-2 space-y-1">$1</ul>')
  
  // Checkboxes
  html = html.replace(/\[x\]/gi, '<input type="checkbox" checked disabled class="mr-2" />')
  html = html.replace(/\[\s\]/g, '<input type="checkbox" disabled class="mr-2" />')
  
  // Line breaks
  html = html.replace(/\n\n/g, '</p><p class="my-2">')
  html = html.replace(/\n/g, '<br />')
  
  // Wrap in paragraph if not already wrapped
  if (!html.trim().startsWith('<')) {
    html = '<p>' + html + '</p>'
  }
  
  return html
}

export function MarkdownPreview({ content, open, onOpenChange }: MarkdownPreviewProps) {
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "P") {
        e.preventDefault()
        onOpenChange(!open)
      }
      if (e.key === "Escape" && open) {
        onOpenChange(false)
      }
    }

    window.addEventListener("keydown", handleKeyDown)
    return () => window.removeEventListener("keydown", handleKeyDown)
  }, [open, onOpenChange])

  const renderedContent = renderMarkdown(content || "")

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh] bg-card">
        <DialogHeader>
          <DialogTitle className="flex items-center justify-between">
            <span>Markdown Preview</span>
            <button
              onClick={() => onOpenChange(false)}
              className="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
            >
              <X className="h-4 w-4" />
            </button>
          </DialogTitle>
        </DialogHeader>
        <ScrollArea className="max-h-[calc(90vh-100px)]">
          <div
            className="prose prose-invert max-w-none p-4 text-sm"
            dangerouslySetInnerHTML={{ __html: renderedContent }}
          />
        </ScrollArea>
      </DialogContent>
    </Dialog>
  )
}
