"use client"

import React from "react"

import { useState, useCallback, useEffect } from "react"
import { FileText, Save, Tag, Clock, Eye } from "lucide-react"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import { cn } from "@/lib/utils"
import { MarkdownPreview } from "@/components/pentest/markdown-preview"

interface FindingsEditorProps {
  value: string
  onChange: (value: string) => void
  onSave?: () => void
  phase: string
  hasUnsavedChanges?: boolean
}

const phaseColors: Record<string, string> = {
  reconnaissance: "bg-primary/20 text-primary",
  enumeration: "bg-warning/20 text-warning",
  exploitation: "bg-destructive/20 text-destructive",
  "post-exploitation": "bg-success/20 text-success",
  reporting: "bg-muted text-muted-foreground",
}

export function FindingsEditor({ value, onChange, onSave, phase, hasUnsavedChanges = false }: FindingsEditorProps) {
  const [lastSaved, setLastSaved] = useState<Date>(new Date())
  const [isSaving, setIsSaving] = useState(false)
  const [showPreview, setShowPreview] = useState(false)

  const handleSave = useCallback(async () => {
    setIsSaving(true)
    try {
      if (onSave) {
        await onSave()
      }
      setLastSaved(new Date())
    } catch (error) {
      console.error("Failed to save findings:", error)
    } finally {
      setIsSaving(false)
    }
  }, [onSave])

  const handleChange = (newValue: string) => {
    onChange(newValue)
  }

  const handlePaste = async (e: React.ClipboardEvent<HTMLTextAreaElement>) => {
    const text = e.clipboardData.getData("text")
    // Check if it looks like command output (contains newlines and special characters)
    if (text.includes("\n") && (text.includes("PORT") || text.includes("tcp") || text.includes("udp"))) {
      e.preventDefault()
      const wrapped = `\n\`\`\`\n${text}\n\`\`\`\n`
      const target = e.target as HTMLTextAreaElement
      const start = target.selectionStart
      const end = target.selectionEnd
      const newValue = value.slice(0, start) + wrapped + value.slice(end)
      onChange(newValue)
    }
  }

  return (
    <div className="flex h-full flex-col bg-background">
      <div className="flex h-10 shrink-0 items-center justify-between border-b border-border px-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center gap-2">
            <FileText className="h-4 w-4 text-muted-foreground" />
            <span className="text-sm font-medium">Findings</span>
          </div>
          <Badge variant="secondary" className={cn("text-xs", phaseColors[phase])}>
            <Tag className="mr-1 h-3 w-3" />
            {phase}
          </Badge>
        </div>
        <div className="flex items-center gap-3">
          <div className="flex items-center gap-1.5 text-xs text-muted-foreground">
            <Clock className="h-3 w-3" />
            <span>
              {isSaving ? "Saving..." : hasUnsavedChanges ? "Auto-saving..." : `Saved ${formatTime(lastSaved)}`}
            </span>
          </div>
          <Button
            variant="ghost"
            size="sm"
            className="h-7 px-2 text-xs"
            onClick={() => setShowPreview(true)}
            title="Preview (Ctrl+Shift+P)"
          >
            <Eye className="mr-1.5 h-3 w-3" />
            Preview
          </Button>
          <Button
            variant="ghost"
            size="sm"
            className="h-7 px-2 text-xs"
            onClick={handleSave}
            disabled={isSaving}
          >
            <Save className="mr-1.5 h-3 w-3" />
            Save
          </Button>
        </div>
      </div>

      <div className="relative flex-1 min-h-0 overflow-hidden">
        <Textarea
          value={value ?? ""}
          onChange={(e) => handleChange(e.target.value)}
          onPaste={handlePaste}
          placeholder="# Start documenting your findings...

Use Markdown syntax for formatting:
- ## Headings for sections
- **bold** for emphasis
- ``` code blocks ``` for command output
- [x] checkboxes for tasks"
          className={cn(
            "h-full w-full resize-none rounded-none border-0 bg-background p-4",
            "font-mono text-sm leading-relaxed",
            "placeholder:text-muted-foreground/50",
            "focus-visible:ring-0 focus-visible:ring-offset-0"
          )}
          style={{
            tabSize: 2,
          }}
        />
        <MarkdownPreviewHint />
      </div>
      <MarkdownPreview
        content={value}
        open={showPreview}
        onOpenChange={setShowPreview}
      />
    </div>
  )
}

function MarkdownPreviewHint() {
  return (
    <div className="pointer-events-none absolute bottom-3 right-3 flex items-center gap-2 rounded-md bg-card/80 px-2 py-1 text-[10px] text-muted-foreground backdrop-blur-sm">
      <span>Markdown supported</span>
      <kbd className="rounded bg-muted px-1 font-mono">Ctrl+Shift+P</kbd>
      <span>to preview</span>
    </div>
  )
}

function formatTime(date: Date): string {
  const now = new Date()
  const diff = Math.floor((now.getTime() - date.getTime()) / 1000)
  
  if (diff < 10) return "just now"
  if (diff < 60) return `${diff}s ago`
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`
  return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
}
