"use client"

import { Shield, Cloud, CloudOff, RefreshCw, FolderOpen } from "lucide-react"
import { Badge } from "@/components/ui/badge"
import { GuidePopup } from "@/components/pentest/guide-popup"
import { LogoutButton } from "@/components/auth/logout-button"
import { ThemeToggle } from "@/components/theme-toggle"
import { useEngagementContext } from "@/contexts/engagement-context"

interface AppHeaderProps {
  syncStatus: "synced" | "syncing" | "offline"
  onLogoClick?: () => void
  minimal?: boolean // For homepage - hide engagement info, guide, etc.
  onNavigateToEngagements?: () => void // Callback to navigate to engagement view
}

const phaseLabels: Record<string, string> = {
  reconnaissance: "Recon",
  enumeration: "Enum",
  exploitation: "Exploit",
  "post-exploitation": "Post-Exploit",
  reporting: "Report",
}

const phaseColors: Record<string, string> = {
  reconnaissance: "bg-primary/20 text-primary",
  enumeration: "bg-warning/20 text-warning",
  exploitation: "bg-destructive/20 text-destructive",
  "post-exploitation": "bg-success/20 text-success",
  reporting: "bg-muted text-muted-foreground",
}

export function AppHeader({ syncStatus, onLogoClick, minimal = false, onNavigateToEngagements }: AppHeaderProps) {
  const { activeEngagement, setActiveEngagement, engagements } = useEngagementContext()

  const handleLogoClick = () => {
    if (minimal) {
      // On homepage, just scroll to top
      if (onLogoClick) {
        onLogoClick()
      }
    } else {
      // Clear active engagement and skip auto-selection
      setActiveEngagement(null, true)
      // Show homepage if callback provided
      if (onLogoClick) {
        onLogoClick()
      }
    }
  }

  return (
    <header className="flex h-12 shrink-0 items-center justify-between border-b border-border bg-card px-4">
      <div className="flex items-center gap-3">
        <button
          onClick={handleLogoClick}
          className="flex items-center gap-2 transition-opacity hover:opacity-80 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-md px-1 -ml-1"
          title={minimal ? "Scroll to top" : "Go to homepage"}
        >
          <Shield className="h-5 w-5 text-primary" />
          <span className="font-semibold text-sm">Pentest Notebook</span>
        </button>
        {minimal && engagements.length > 0 && onNavigateToEngagements && (
          <button
            onClick={onNavigateToEngagements}
            className="flex items-center gap-1.5 rounded-md px-3 py-1.5 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
            title="View engagements"
          >
            <FolderOpen className="h-4 w-4" />
            <span>Engagements</span>
          </button>
        )}
        {!minimal && <GuidePopup />}
      </div>

      {!minimal && (
        <div className="flex items-center gap-2">
          {activeEngagement ? (
            <span className="text-sm text-muted-foreground">
              {activeEngagement.name}
            </span>
          ) : (
            <span className="text-sm text-muted-foreground">No engagement selected</span>
          )}
        </div>
      )}

      <div className="flex items-center gap-3">
        {!minimal && activeEngagement && (
          <Badge 
            variant="secondary" 
            className={`${phaseColors[activeEngagement.phase]} border-0 font-mono text-xs`}
          >
            {phaseLabels[activeEngagement.phase]}
          </Badge>
        )}
        
        {!minimal && (
          <div className="flex items-center gap-1.5 text-muted-foreground">
            {syncStatus === "synced" && (
              <>
                <Cloud className="h-4 w-4 text-success" />
                <span className="text-xs">Synced</span>
              </>
            )}
            {syncStatus === "syncing" && (
              <>
                <RefreshCw className="h-4 w-4 animate-spin text-primary" />
                <span className="text-xs">Syncing</span>
              </>
            )}
            {syncStatus === "offline" && (
              <>
                <CloudOff className="h-4 w-4 text-warning" />
                <span className="text-xs">Offline</span>
              </>
            )}
          </div>
        )}
        
        <div className="flex items-center gap-2">
          <ThemeToggle />
          <LogoutButton />
        </div>
      </div>
    </header>
  )
}
