"use client"

import { useState } from "react"
import { X, Copy, Check, AlertTriangle } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Separator } from "@/components/ui/separator"
import { cn } from "@/lib/utils"
import type { Technique } from "@/lib/types"

interface TechniqueDrawerProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  technique: Technique | null
  onCopyCommand: (command: string) => void
}

export function TechniqueDrawer({
  open,
  onOpenChange,
  technique,
  onCopyCommand,
}: TechniqueDrawerProps) {
  const [inputValues, setInputValues] = useState<Record<string, string>>({})

  if (!technique) return null

  const replaceVariables = (command: string) => {
    let result = command
    for (const input of technique.inputs) {
      const value = inputValues[input.name] || input.placeholder
      result = result.replace(new RegExp(`{{${input.name}}}`, "g"), value)
    }
    return result
  }

  return (
    <>
      {/* Backdrop */}
      <div
        className={cn(
          "fixed inset-0 z-40 bg-background/80 backdrop-blur-sm transition-opacity",
          open ? "opacity-100" : "pointer-events-none opacity-0"
        )}
        onClick={() => onOpenChange(false)}
        onKeyDown={(e) => {
          if (e.key === "Escape") onOpenChange(false)
        }}
      />

      {/* Drawer */}
      <div
        className={cn(
          "fixed bottom-0 right-0 top-0 z-50 w-[480px] border-l border-border bg-card shadow-xl transition-transform duration-300",
          open ? "translate-x-0" : "translate-x-full"
        )}
      >
        <div className="flex h-full flex-col">
          {/* Header */}
          <div className="flex items-center justify-between border-b border-border px-4 py-3">
            <h2 className="text-lg font-semibold">{technique.title}</h2>
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8"
              onClick={() => onOpenChange(false)}
            >
              <X className="h-4 w-4" />
            </Button>
          </div>

          <ScrollArea className="flex-1">
            <div className="space-y-6 p-4">
              {/* Description */}
              <section>
                <h3 className="mb-2 text-sm font-medium text-muted-foreground">
                  Description
                </h3>
                <p className="text-sm leading-relaxed">{technique.description}</p>
              </section>

              <Separator />

              {/* Inputs */}
              <section>
                <h3 className="mb-3 text-sm font-medium text-muted-foreground">
                  Inputs
                </h3>
                <div className="space-y-3">
                  {technique.inputs.map((input) => (
                    <div key={input.name} className="space-y-1.5">
                      <Label htmlFor={input.name} className="text-xs">
                        {input.name}
                        <span className="ml-2 font-normal text-muted-foreground">
                          {input.description}
                        </span>
                      </Label>
                      <Input
                        id={input.name}
                        placeholder={input.placeholder}
                        value={inputValues[input.name] || ""}
                        onChange={(e) =>
                          setInputValues({
                            ...inputValues,
                            [input.name]: e.target.value,
                          })
                        }
                        className="bg-input font-mono text-sm"
                      />
                    </div>
                  ))}
                </div>
              </section>

              <Separator />

              {/* Commands */}
              <section>
                <h3 className="mb-3 text-sm font-medium text-muted-foreground">
                  Commands
                </h3>
                <div className="space-y-2">
                  {technique.commands.map((command, index) => (
                    <CommandBlock
                      key={index}
                      command={replaceVariables(command)}
                      onCopy={onCopyCommand}
                    />
                  ))}
                </div>
              </section>

              <Separator />

              {/* Expected Output */}
              <section>
                <h3 className="mb-2 text-sm font-medium text-muted-foreground">
                  Expected Output
                </h3>
                <p className="text-sm text-muted-foreground">
                  {technique.expectedOutput}
                </p>
              </section>

              <Separator />

              {/* Notes */}
              <section>
                <div className="flex items-start gap-2 rounded-md border border-warning/30 bg-warning/10 p-3">
                  <AlertTriangle className="mt-0.5 h-4 w-4 shrink-0 text-warning" />
                  <div>
                    <h3 className="mb-1 text-sm font-medium text-warning">
                      Important Notes
                    </h3>
                    <p className="text-xs text-warning/80">{technique.notes}</p>
                  </div>
                </div>
              </section>
            </div>
          </ScrollArea>
        </div>
      </div>
    </>
  )
}

interface CommandBlockProps {
  command: string
  onCopy: (command: string) => void
}

function CommandBlock({ command, onCopy }: CommandBlockProps) {
  const [copied, setCopied] = useState(false)

  const handleCopy = () => {
    onCopy(command)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }

  return (
    <div className="group relative overflow-hidden rounded-md bg-background">
      <pre className="overflow-x-auto p-3 font-mono text-xs leading-relaxed">
        <code>{command}</code>
      </pre>
      <Button
        variant="ghost"
        size="icon"
        className={cn(
          "absolute right-1 top-1 h-7 w-7 opacity-0 transition-opacity group-hover:opacity-100",
          copied && "opacity-100"
        )}
        onClick={handleCopy}
      >
        {copied ? (
          <Check className="h-3.5 w-3.5 text-success" />
        ) : (
          <Copy className="h-3.5 w-3.5" />
        )}
      </Button>
    </div>
  )
}
