"use client"

import { useState } from "react"
import { X, BookOpen, Lightbulb, Target, FileText, Shield } from "lucide-react"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Badge } from "@/components/ui/badge"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import { cn } from "@/lib/utils"

export function GuidePopup() {
  const [open, setOpen] = useState(false)

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button
          variant="outline"
          size="sm"
          className="gap-2"
          onClick={() => setOpen(true)}
        >
          <BookOpen className="h-4 w-4" />
          Guide
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-4xl max-h-[90vh] bg-card">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Lightbulb className="h-5 w-5 text-primary" />
            Penethodix Guide
          </DialogTitle>
        </DialogHeader>
        <ScrollArea className="max-h-[calc(90vh-100px)] pr-4">
          <div className="space-y-6">
            {/* Overview */}
            <section>
              <h3 className="mb-3 text-lg font-semibold">Getting Started</h3>
              <p className="mb-4 text-sm text-muted-foreground">
                Penethodix is a state-aware penetration testing notebook that helps you organize
                engagements, track targets, document findings, and get intelligent suggestions based
                on detected services.
              </p>
            </section>

            {/* Engagements */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <FileText className="h-4 w-4 text-primary" />
                <h3 className="text-lg font-semibold">Engagements</h3>
              </div>
              <div className="space-y-2 text-sm">
                <p>
                  <strong>Engagements</strong> represent your penetration testing projects. Each
                  engagement has a phase (reconnaissance, enumeration, exploitation, etc.) and
                  status.
                </p>
                <ul className="ml-4 list-disc space-y-1 text-muted-foreground">
                  <li>Create a new engagement to get started</li>
                  <li>Switch between engagements using the sidebar</li>
                  <li>Update the phase as you progress through your testing</li>
                </ul>
              </div>
            </section>

            {/* Targets */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <Target className="h-4 w-4 text-primary" />
                <h3 className="text-lg font-semibold">Targets & Ports</h3>
              </div>
              <div className="space-y-2 text-sm">
                <p>
                  <strong>Targets</strong> are IP addresses or hostnames you're testing. Add ports
                  and services to each target as you discover them.
                </p>
                <ul className="ml-4 list-disc space-y-1 text-muted-foreground">
                  <li>Click the "+" button in the Targets panel to add a new target</li>
                  <li>Expand a target to see its ports and add new ones</li>
                  <li>Mark targets as in-scope or discovered during recon</li>
                  <li>Ports are automatically used by the suggestion engine</li>
                </ul>
              </div>
            </section>

            {/* Findings */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <FileText className="h-4 w-4 text-primary" />
                <h3 className="text-lg font-semibold">Findings Editor</h3>
              </div>
              <div className="space-y-2 text-sm">
                <p>
                  The <strong>Findings Editor</strong> is a markdown editor where you document your
                  discoveries, scan results, and notes.
                </p>
                <ul className="ml-4 list-disc space-y-1 text-muted-foreground">
                  <li>Supports full Markdown syntax</li>
                  <li>Auto-saves to the database</li>
                  <li>Paste command output - it will be automatically wrapped in code blocks</li>
                  <li>Use checkboxes for task tracking</li>
                </ul>
              </div>
            </section>

            {/* Suggestions */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <Lightbulb className="h-4 w-4 text-primary" />
                <h3 className="text-lg font-semibold">Suggestions Panel</h3>
              </div>
              <div className="space-y-2 text-sm">
                <p>
                  The <strong>Suggestions Panel</strong> provides intelligent recommendations based
                  on your targets and detected services.
                </p>
                <ul className="ml-4 list-disc space-y-1 text-muted-foreground">
                  <li>Suggestions appear automatically when rules match your targets</li>
                  <li>Grouped by service for easy navigation</li>
                  <li>Click the copy button to copy commands to clipboard</li>
                  <li>Commands automatically replace &lt;target&gt; with the selected target IP</li>
                  <li>Confidence levels: High (green), Medium (yellow), Low (gray)</li>
                </ul>
              </div>
            </section>

            {/* Knowledge Base */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <BookOpen className="h-4 w-4 text-primary" />
                <h3 className="text-lg font-semibold">Knowledge Base</h3>
              </div>
              <div className="space-y-2 text-sm">
                <p>
                  The <strong>Knowledge Base</strong> is your reference library of techniques,
                  tools, and methodologies.
                </p>
                <ul className="ml-4 list-disc space-y-1 text-muted-foreground">
                  <li>Browse entries by category (domain/topic)</li>
                  <li>Filter by phase, tags, service, or OWASP category</li>
                  <li>View step-by-step procedures and commands</li>
                  <li>Edit entries to customize for your workflow</li>
                </ul>
                <div className="mt-3 rounded-md border border-border bg-muted/50 p-3">
                  <p className="mb-2 text-xs font-semibold text-foreground">Categories vs Phases:</p>
                  <ul className="ml-4 list-disc space-y-1 text-xs text-muted-foreground">
                    <li><strong>Categories</strong> (required): What domain/topic? e.g., "Web Apps", "Network", "Cloud"</li>
                    <li><strong>Phases</strong> (optional): When in methodology? e.g., "Reconnaissance", "Enumeration"</li>
                    <li>Use categories to organize by subject, phases to organize by workflow stage</li>
                    <li>If a category name matches a phase, the phase is auto-set for convenience</li>
                  </ul>
                </div>
              </div>
            </section>

            {/* Rules */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <Shield className="h-4 w-4 text-primary" />
                <h3 className="text-lg font-semibold">Rules</h3>
              </div>
              <div className="space-y-2 text-sm">
                <p>
                  <strong>Rules</strong> define when suggestions should appear. They evaluate
                  conditions (like detected services) and provide suggestions.
                </p>
                <ul className="ml-4 list-disc space-y-1 text-muted-foreground">
                  <li>Rules are evaluated automatically based on your targets</li>
                  <li>Enable/disable rules to control which suggestions appear</li>
                  <li>Edit rules to customize conditions and suggestions</li>
                  <li>Rules are phase-specific (only active during matching phases)</li>
                </ul>
              </div>
            </section>

            {/* Example Data */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <Badge variant="secondary">Example Data</Badge>
              </div>
              <div className="space-y-2 text-sm">
                <p className="text-muted-foreground">
                  If you ran the seed data script, you should see:
                </p>
                <ul className="ml-4 list-disc space-y-1 text-muted-foreground">
                  <li>1 example engagement with 2 targets</li>
                  <li>5 knowledge base entries covering common techniques</li>
                  <li>5 rules that generate suggestions automatically</li>
                  <li>Example findings to show the markdown format</li>
                </ul>
                <p className="mt-2 text-xs text-muted-foreground">
                  You can edit or delete any of this example data to customize it for your needs.
                </p>
              </div>
            </section>

            {/* Keyboard Shortcuts */}
            <section>
              <div className="mb-3 flex items-center gap-2">
                <Badge variant="outline">Tips & Shortcuts</Badge>
              </div>
              <div className="space-y-2 text-sm text-muted-foreground">
                <p>Press <kbd className="rounded bg-muted px-1.5 py-0.5 text-xs">?</kbd> to see all keyboard shortcuts</p>
                <p><strong>Knowledge Base shortcuts:</strong></p>
                <ul className="ml-4 list-disc space-y-1">
                  <li><kbd className="rounded bg-muted px-1.5 py-0.5 text-xs">Alt+E</kbd> - Add entry</li>
                  <li><kbd className="rounded bg-muted px-1.5 py-0.5 text-xs">Alt+C</kbd> - Add category</li>
                  <li><kbd className="rounded bg-muted px-1.5 py-0.5 text-xs">Alt+P</kbd> - Add phase (in Knowledge Base) or switch engagement phase</li>
                </ul>
                <p className="mt-2">All data is saved automatically to Supabase</p>
                <p>Changes sync in real-time across multiple browser tabs</p>
              </div>
            </section>
          </div>
        </ScrollArea>
      </DialogContent>
    </Dialog>
  )
}
