"use client"

import { useState } from "react"
import {
  Server,
  Plus,
  ChevronDown,
  ChevronRight,
  Circle,
  Globe,
  Database,
  Box,
} from "lucide-react"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Badge } from "@/components/ui/badge"
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog"
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Checkbox } from "@/components/ui/checkbox"
import { cn } from "@/lib/utils"
import type { Target, Port } from "@/lib/types"

interface TargetPanelProps {
  targets: Target[]
  selectedTarget: Target | null
  onTargetSelect: (target: Target) => void
  onAddTarget: (target: Omit<Target, "id" | "ports">) => void
  onAddPort: (targetId: string, port: Port) => void
}

const portStatusColors: Record<string, string> = {
  open: "text-success",
  closed: "text-destructive",
  filtered: "text-warning",
}

const portStatusBg: Record<string, string> = {
  open: "bg-success/20",
  closed: "bg-destructive/20",
  filtered: "bg-warning/20",
}

export function TargetPanel({
  targets,
  selectedTarget,
  onTargetSelect,
  onAddTarget,
  onAddPort,
}: TargetPanelProps) {
  const [expandedTargets, setExpandedTargets] = useState<Set<string>>(
    new Set(targets.map((t) => t.id))
  )
  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set())
  const [addTargetDialogOpen, setAddTargetDialogOpen] = useState(false)
  const [addPortDialogOpen, setAddPortDialogOpen] = useState(false)
  const [portTargetId, setPortTargetId] = useState<string | null>(null)
  const [newTarget, setNewTarget] = useState({
    ip: "",
    label: "",
    inScope: false,
    discoveredDuringRecon: false,
  })
  const [newPort, setNewPort] = useState({
    port: "",
    service: "",
    version: "",
    status: "open" as Port["status"],
  })

  const toggleExpanded = (targetId: string) => {
    setExpandedTargets((prev) => {
      const next = new Set(prev)
      if (next.has(targetId)) {
        next.delete(targetId)
      } else {
        next.add(targetId)
      }
      return next
    })
  }

  const toggleSection = (sectionId: string) => {
    setExpandedSections((prev) => {
      const next = new Set(prev)
      if (next.has(sectionId)) {
        next.delete(sectionId)
      } else {
        next.add(sectionId)
      }
      return next
    })
  }

  const handleAddTarget = () => {
    if (!newTarget.ip.trim()) return
    onAddTarget({
      ip: newTarget.ip.trim(),
      label: newTarget.label.trim() || undefined,
      inScope: newTarget.inScope,
      discoveredDuringRecon: newTarget.discoveredDuringRecon,
    })
    setNewTarget({ ip: "", label: "", inScope: false, discoveredDuringRecon: false })
    setAddTargetDialogOpen(false)
  }

  const handleOpenAddPort = (targetId: string) => {
    setPortTargetId(targetId)
    setAddPortDialogOpen(true)
  }

  const handleAddPort = () => {
    if (!portTargetId || !newPort.port.trim() || !newPort.service.trim()) return
    const portNumber = parseInt(newPort.port.trim(), 10)
    if (isNaN(portNumber) || portNumber < 1 || portNumber > 65535) return

    onAddPort(portTargetId, {
      port: portNumber,
      service: newPort.service.trim(),
      version: newPort.version.trim() || "",
      status: newPort.status,
    })
    setNewPort({ port: "", service: "", version: "", status: "open" })
    setAddPortDialogOpen(false)
    setPortTargetId(null)
  }

  // Group ports by service for the target view
  const groupPortsByService = (ports: Port[]) => {
    const services: Record<string, Port[]> = {}
    for (const port of ports) {
      if (!services[port.service]) {
        services[port.service] = []
      }
      services[port.service].push(port)
    }
    return services
  }

  return (
    <div className="flex w-64 shrink-0 flex-col border-r border-border bg-card">
      <div className="flex h-10 items-center justify-between border-b border-border px-3">
        <div className="flex items-center gap-2">
          <Server className="h-4 w-4 text-muted-foreground" />
          <span className="text-sm font-medium">Targets</span>
        </div>
        <Dialog open={addTargetDialogOpen} onOpenChange={setAddTargetDialogOpen}>
          <DialogTrigger asChild>
            <Button variant="ghost" size="sm" className="h-6 gap-1 px-2 text-xs">
              <Plus className="h-3 w-3" />
              Targets
            </Button>
          </DialogTrigger>
          <DialogContent className="bg-card sm:max-w-md">
            <DialogHeader>
              <DialogTitle>Add Target</DialogTitle>
            </DialogHeader>
            <div className="space-y-4 py-4">
              <div className="space-y-2">
                <Label htmlFor="ip">IP / Hostname</Label>
                <Input
                  id="ip"
                  placeholder="192.168.1.100"
                  value={newTarget.ip}
                  onChange={(e) => setNewTarget({ ...newTarget, ip: e.target.value })}
                  className="bg-input font-mono"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="label">Label (optional)</Label>
                <Input
                  id="label"
                  placeholder="web-server-01"
                  value={newTarget.label}
                  onChange={(e) => setNewTarget({ ...newTarget, label: e.target.value })}
                  className="bg-input"
                />
              </div>
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="inScope"
                    checked={newTarget.inScope}
                    onCheckedChange={(checked) =>
                      setNewTarget({ ...newTarget, inScope: checked === true })
                    }
                  />
                  <Label htmlFor="inScope" className="cursor-pointer text-sm font-normal">
                    Part of scope
                  </Label>
                </div>
                <div className="flex items-center gap-3">
                  <Checkbox
                    id="discovered"
                    checked={newTarget.discoveredDuringRecon}
                    onCheckedChange={(checked) =>
                      setNewTarget({ ...newTarget, discoveredDuringRecon: checked === true })
                    }
                  />
                  <Label htmlFor="discovered" className="cursor-pointer text-sm font-normal">
                    Discovered during recon
                  </Label>
                </div>
              </div>
              <Button onClick={handleAddTarget} className="w-full">
                Add Target
              </Button>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      {/* Add Port Dialog */}
      <Dialog open={addPortDialogOpen} onOpenChange={setAddPortDialogOpen}>
        <DialogContent className="bg-card sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Add Port</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label htmlFor="port">Port Number</Label>
              <Input
                id="port"
                type="number"
                placeholder="80"
                min="1"
                max="65535"
                value={newPort.port}
                onChange={(e) => setNewPort({ ...newPort, port: e.target.value })}
                className="bg-input font-mono"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="service">Service</Label>
              <Input
                id="service"
                placeholder="http"
                value={newPort.service}
                onChange={(e) => setNewPort({ ...newPort, service: e.target.value })}
                className="bg-input"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="version">Version (optional)</Label>
              <Input
                id="version"
                placeholder="nginx 1.18.0"
                value={newPort.version}
                onChange={(e) => setNewPort({ ...newPort, version: e.target.value })}
                className="bg-input"
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="status">Status</Label>
              <Select
                value={newPort.status}
                onValueChange={(value: Port["status"]) =>
                  setNewPort({ ...newPort, status: value })
                }
              >
                <SelectTrigger className="bg-input">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="open">Open</SelectItem>
                  <SelectItem value="closed">Closed</SelectItem>
                  <SelectItem value="filtered">Filtered</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <Button onClick={handleAddPort} className="w-full" disabled={!newPort.port || !newPort.service}>
              Add Port
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      <ScrollArea className="flex-1">
        <div className="p-2">
          {targets.map((target) => {
            const isExpanded = expandedTargets.has(target.id)
            const isSelected = selectedTarget?.id === target.id
            const services = groupPortsByService(target.ports)

            return (
              <div key={target.id} className="mb-2">
                <button
                  type="button"
                  onClick={() => {
                    onTargetSelect(target)
                    toggleExpanded(target.id)
                  }}
                  className={cn(
                    "flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-left transition-colors",
                    isSelected
                      ? "bg-primary/10 text-primary"
                      : "hover:bg-secondary"
                  )}
                >
                  {isExpanded ? (
                    <ChevronDown className="h-3.5 w-3.5 shrink-0" />
                  ) : (
                    <ChevronRight className="h-3.5 w-3.5 shrink-0" />
                  )}
                  <div className="min-w-0 flex-1">
                    <div className="flex items-center gap-1.5">
                      <span className="truncate font-mono text-xs">{target.ip}</span>
                      {target.inScope && (
                        <Badge variant="outline" className="h-4 px-1 text-[9px] text-success border-success/30">
                          scope
                        </Badge>
                      )}
                    </div>
                    {target.label && (
                      <div className="truncate text-xs text-muted-foreground">
                        {target.label}
                      </div>
                    )}
                  </div>
                </button>

                {isExpanded && (
                  <div className="ml-3 mt-1 border-l border-border pl-2">
                    {/* Ports Section */}
                    <div className="mb-1">
                      <div className="flex items-center gap-1">
                        <button
                          type="button"
                          onClick={() => toggleSection(`${target.id}-ports`)}
                          className="flex flex-1 items-center gap-1.5 rounded px-2 py-1 text-xs text-muted-foreground hover:bg-secondary/50"
                        >
                          {expandedSections.has(`${target.id}-ports`) ? (
                            <ChevronDown className="h-3 w-3" />
                          ) : (
                            <ChevronRight className="h-3 w-3" />
                          )}
                          <Globe className="h-3 w-3" />
                          <span>Ports</span>
                          <span className="ml-auto text-[10px]">{target.ports.length}</span>
                        </button>
                        <button
                          type="button"
                          onClick={() => handleOpenAddPort(target.id)}
                          className="rounded px-1.5 py-1 text-xs text-muted-foreground hover:bg-secondary/50 hover:text-foreground"
                          title="Add port"
                        >
                          <Plus className="h-3 w-3" />
                        </button>
                      </div>
                      {expandedSections.has(`${target.id}-ports`) && (
                        <div className="ml-5 mt-0.5 space-y-0.5">
                          {target.ports.length === 0 ? (
                            <div className="px-2 py-1 text-xs text-muted-foreground">
                              No ports added
                            </div>
                          ) : (
                            target.ports.map((port) => (
                              <PortItem key={port.port} port={port} />
                            ))
                          )}
                        </div>
                      )}
                    </div>

                    {/* Services Section */}
                    <div className="mb-1">
                      <button
                        type="button"
                        onClick={() => toggleSection(`${target.id}-services`)}
                        className="flex w-full items-center gap-1.5 rounded px-2 py-1 text-xs text-muted-foreground hover:bg-secondary/50"
                      >
                        {expandedSections.has(`${target.id}-services`) ? (
                          <ChevronDown className="h-3 w-3" />
                        ) : (
                          <ChevronRight className="h-3 w-3" />
                        )}
                        <Database className="h-3 w-3" />
                        <span>Services</span>
                        <span className="ml-auto text-[10px]">{Object.keys(services).length}</span>
                      </button>
                      {expandedSections.has(`${target.id}-services`) && (
                        <div className="ml-5 mt-0.5 space-y-0.5">
                          {Object.entries(services).map(([service, ports]) => (
                            <div
                              key={service}
                              className="flex items-center gap-2 rounded px-2 py-1 text-xs hover:bg-secondary/50"
                            >
                              <span className="font-medium">{service}</span>
                              <span className="text-muted-foreground">
                                ({ports.map((p) => p.port).join(", ")})
                              </span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Versions Section */}
                    <div>
                      <button
                        type="button"
                        onClick={() => toggleSection(`${target.id}-versions`)}
                        className="flex w-full items-center gap-1.5 rounded px-2 py-1 text-xs text-muted-foreground hover:bg-secondary/50"
                      >
                        {expandedSections.has(`${target.id}-versions`) ? (
                          <ChevronDown className="h-3 w-3" />
                        ) : (
                          <ChevronRight className="h-3 w-3" />
                        )}
                        <Box className="h-3 w-3" />
                        <span>Versions</span>
                      </button>
                      {expandedSections.has(`${target.id}-versions`) && (
                        <div className="ml-5 mt-0.5 space-y-0.5">
                          {target.ports.filter((p) => p.version).map((port) => (
                            <div
                              key={port.port}
                              className="flex items-center gap-2 rounded px-2 py-1 text-xs hover:bg-secondary/50"
                            >
                              <span className="text-muted-foreground">{port.service}</span>
                              <span className="font-mono text-[10px]">{port.version}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )
          })}
        </div>
      </ScrollArea>

      {selectedTarget && (
        <div className="border-t border-border p-3">
          <div className="text-xs text-muted-foreground">
            <div className="mb-1 font-medium text-foreground">Service Map</div>
            <div className="flex flex-wrap gap-1">
              {selectedTarget.ports.map((port) => (
                <Badge
                  key={port.port}
                  variant="secondary"
                  className={cn(
                    "font-mono text-[10px]",
                    portStatusBg[port.status],
                    portStatusColors[port.status]
                  )}
                >
                  {port.service}:{port.port}
                </Badge>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

function PortItem({ port }: { port: Port }) {
  return (
    <div className="flex items-center gap-2 rounded px-2 py-0.5 text-xs hover:bg-secondary/50">
      <Circle
        className={cn("h-2 w-2", portStatusColors[port.status])}
        fill="currentColor"
      />
      <span className="font-mono text-muted-foreground">{port.port}</span>
      <span className="flex-1 truncate">{port.service}</span>
    </div>
  )
}
