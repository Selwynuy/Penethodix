"use client"

import { useMemo, useState } from "react"
import {
  Lightbulb,
  ChevronDown,
  ChevronRight,
  Copy,
  Check,
  Shield,
  AlertCircle,
  Info,
  Sparkles,
} from "lucide-react"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { Badge } from "@/components/ui/badge"
import { cn } from "@/lib/utils"
import type { Engagement, Target, Rule } from "@/lib/types"
import {
  evaluateAllRules,
  groupSuggestionsByService,
  type EvaluatedSuggestion,
  type GroupedSuggestions,
} from "@/lib/rule-evaluator"

interface SuggestionsPanelProps {
  targets: Target[]
  activeEngagement: Engagement
  rules: Rule[]
  selectedTarget?: Target | null
}

const confidenceColors: Record<string, { bg: string; text: string; border: string }> = {
  high: {
    bg: "bg-success/20",
    text: "text-success",
    border: "border-success/30",
  },
  medium: {
    bg: "bg-warning/20",
    text: "text-warning",
    border: "border-warning/30",
  },
  low: {
    bg: "bg-muted",
    text: "text-muted-foreground",
    border: "border-muted",
  },
}

function SuggestionsPanelHeader({ count }: { count: number }) {
  return (
    <div className="flex h-10 items-center justify-between border-b border-border px-3">
      <div className="flex items-center gap-2">
        <Lightbulb className="h-4 w-4 text-muted-foreground" />
        <span className="text-sm font-medium">Suggestions</span>
        {count > 0 && (
          <Badge variant="secondary" className="h-5 px-1.5 text-[10px]">
            {count}
          </Badge>
        )}
      </div>
    </div>
  )
}

function SuggestionItem({
  suggestion,
  onCopyCommand,
  selectedTarget,
  targets,
}: {
  suggestion: EvaluatedSuggestion
  onCopyCommand: (command: string) => void
  selectedTarget?: Target | null
  targets: Target[]
}) {
  const [copiedIndex, setCopiedIndex] = useState<number | null>(null)
  const confidenceStyle = confidenceColors[suggestion.confidence]

  // Get target IP for replacing <target> placeholder
  const targetIp = selectedTarget?.ip || targets[0]?.ip || "<target>"

  const handleCopy = (command: string, index: number) => {
    onCopyCommand(command)
    setCopiedIndex(index)
    setTimeout(() => setCopiedIndex(null), 2000)
  }

  return (
    <div
      className={cn(
        "mb-2 rounded-md border p-3 transition-colors",
        confidenceStyle.border,
        "hover:bg-secondary/50"
      )}
    >
      <div className="mb-2 flex items-start justify-between gap-2">
        <div className="flex-1">
          <div className="mb-1 flex items-center gap-2">
            <h4 className="text-sm font-semibold">{suggestion.title}</h4>
            <Badge
              variant="outline"
              className={cn("h-4 px-1 text-[9px]", confidenceStyle.text, confidenceStyle.border)}
            >
              {suggestion.confidence}
            </Badge>
            {suggestion.owaspTag && (
              <Badge variant="secondary" className="h-4 px-1 text-[9px]">
                {suggestion.owaspTag}
              </Badge>
            )}
          </div>
          {suggestion.description && (
            <p className="text-xs text-muted-foreground">{suggestion.description}</p>
          )}
        </div>
      </div>

      {suggestion.commands && suggestion.commands.length > 0 && (
        <div className="mt-2 space-y-1">
          {suggestion.commands.map((command, index) => {
            // Replace <target> placeholder with actual IP address
            const commandWithTarget = command.replace(/<target>/g, targetIp)
            return (
              <div
                key={index}
                className="group flex items-center gap-2 rounded border border-border bg-muted/30 p-2 font-mono text-xs"
              >
                <code className="flex-1 break-all text-[11px]">{commandWithTarget}</code>
                <Button
                  variant="ghost"
                  size="sm"
                  className="h-6 w-6 shrink-0 p-0 opacity-0 transition-opacity group-hover:opacity-100"
                  onClick={() => handleCopy(command, index)}
                  title="Copy command"
                >
                  {copiedIndex === index ? (
                    <Check className="h-3 w-3 text-success" />
                  ) : (
                    <Copy className="h-3 w-3" />
                  )}
                </Button>
              </div>
            )
          })}
        </div>
      )}
    </div>
  )
}

function SuggestionGroup({
  service,
  suggestions,
  onCopyCommand,
  selectedTarget,
  targets,
}: {
  service: string
  suggestions: EvaluatedSuggestion[]
  onCopyCommand: (command: string) => void
  selectedTarget?: Target | null
  targets: Target[]
}) {
  const [expanded, setExpanded] = useState(true)

  return (
    <div className="mb-3">
      <button
        type="button"
        onClick={() => setExpanded(!expanded)}
        className="flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-left text-xs font-medium text-muted-foreground transition-colors hover:bg-secondary/50"
      >
        {expanded ? (
          <ChevronDown className="h-3.5 w-3.5 shrink-0" />
        ) : (
          <ChevronRight className="h-3.5 w-3.5 shrink-0" />
        )}
        <span className="flex-1 capitalize">{service}</span>
        <Badge variant="secondary" className="h-4 px-1.5 text-[9px]">
          {suggestions.length}
        </Badge>
      </button>
      {expanded && (
        <div className="ml-4 mt-1 space-y-2">
          {suggestions.map((suggestion, index) => (
            <SuggestionItem 
              key={`${suggestion.ruleId}-${index}`} 
              suggestion={suggestion} 
              onCopyCommand={onCopyCommand}
              selectedTarget={selectedTarget}
              targets={targets}
            />
          ))}
        </div>
      )}
    </div>
  )
}

function EmptyState() {
  return (
    <div className="flex flex-col items-center justify-center p-8 text-center">
      <Sparkles className="mb-3 h-12 w-12 text-muted-foreground/50" />
      <p className="mb-1 text-sm font-medium text-foreground">No suggestions available</p>
      <p className="text-xs text-muted-foreground">
        Add targets and ports to get started, or check that rules are enabled for the current phase.
      </p>
    </div>
  )
}

export function SuggestionsPanel({
  targets,
  activeEngagement,
  rules,
  selectedTarget,
}: SuggestionsPanelProps) {
  const [copiedCommand, setCopiedCommand] = useState<string | null>(null)

  // Evaluate rules and group suggestions by service
  // Filter by selected target if one is selected
  const groupedSuggestions = useMemo(() => {
    const suggestions = evaluateAllRules(rules, activeEngagement, targets, selectedTarget)
    return groupSuggestionsByService(suggestions)
  }, [rules, activeEngagement, targets, selectedTarget])

  const totalSuggestions = useMemo(() => {
    return Object.values(groupedSuggestions).reduce((sum, group) => sum + group.length, 0)
  }, [groupedSuggestions])

  const handleCopyCommand = (command: string) => {
    // Replace <target> placeholder with selected target IP or first target IP
    const targetIp = selectedTarget?.ip || targets[0]?.ip || "<target>"
    const commandWithTarget = command.replace(/<target>/g, targetIp)
    
    navigator.clipboard.writeText(commandWithTarget)
    setCopiedCommand(commandWithTarget)
    setTimeout(() => setCopiedCommand(null), 2000)
  }

  const services = Object.keys(groupedSuggestions).sort()

  return (
    <div className="flex h-full w-full flex-col border-l border-border bg-card">
      <SuggestionsPanelHeader count={totalSuggestions} />
      
      <ScrollArea className="flex-1">
        <div className="p-3">
          {totalSuggestions === 0 ? (
            <EmptyState />
          ) : (
            <div>
              {services.map((service) => (
                <SuggestionGroup
                  key={service}
                  service={service}
                  suggestions={groupedSuggestions[service]}
                  onCopyCommand={handleCopyCommand}
                  selectedTarget={selectedTarget}
                  targets={targets}
                />
              ))}
            </div>
          )}
        </div>
      </ScrollArea>
    </div>
  )
}
