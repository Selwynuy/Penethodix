"use client"

import { useState } from "react"
import { ResizablePanelGroup, ResizablePanel, ResizableHandle } from "@/components/ui/resizable"
import { TargetPanel } from "@/components/pentest/target-panel"
import { FindingsEditor } from "@/components/pentest/findings-editor"
import { SuggestionsPanel } from "@/components/pentest/suggestions-panel"
import { useEngagementContext } from "@/contexts/engagement-context"
import type { Engagement, Target, Finding, Rule, Port } from "@/lib/types"

interface EngagementViewProps {
  targets: Target[]
  findings: Finding[]
  rules: Rule[]
  
  onCreateTarget: (newTarget: Omit<Target, "id" | "ports" | "engagement_id">) => Promise<Target>
  onAddPort: (targetId: string, port: Port) => Promise<Target | undefined>
  onDeleteTarget: (targetId: string) => Promise<void>

  onCreateFinding: (finding: Omit<Finding, "id" | "created_at" | "updated_at">) => Promise<Finding>
  onUpdateFinding: (id: string, updates: Partial<Finding>) => Promise<Finding>
  onDeleteFinding: (id: string) => Promise<void>
}

export function EngagementView({
  targets,
  findings,
  rules,
  onCreateTarget,
  onAddPort,
  onDeleteTarget,
  onCreateFinding,
  onUpdateFinding,
  onDeleteFinding,
}: EngagementViewProps) {
  const { activeEngagement } = useEngagementContext()
  const [selectedTarget, setSelectedTarget] = useState<Target | null>(null)

  if (!activeEngagement) {
    return (
      <div className="flex flex-1 items-center justify-center">
        <div className="text-center">
          <p className="mb-4 text-muted-foreground">No engagement selected</p>
          <p className="mb-4 text-sm text-muted-foreground">
            Select an engagement from the sidebar or create a new one
          </p>
        </div>
      </div>
    )
  }

  return (
    <ResizablePanelGroup direction="horizontal">
      <ResizablePanel defaultSize={20} minSize={15}>
        <TargetPanel
          targets={targets}
          selectedTarget={selectedTarget}
          onTargetSelect={setSelectedTarget}
          onAddTarget={onCreateTarget}
          onAddPort={onAddPort}
          onDeleteTarget={onDeleteTarget}
        />
      </ResizablePanel>
      <ResizableHandle withHandle />
      <ResizablePanel defaultSize={50} minSize={30}>
        <FindingsEditor
          findings={findings}
          activeEngagement={activeEngagement}
          targets={targets}
          onCreateFinding={onCreateFinding}
          onUpdateFinding={onUpdateFinding}
          onDeleteFinding={onDeleteFinding}
        />
      </ResizablePanel>
      <ResizableHandle withHandle />
      <ResizablePanel defaultSize={30} minSize={20}>
        <SuggestionsPanel
          targets={targets}
          activeEngagement={activeEngagement}
          rules={rules}
          selectedTarget={selectedTarget}
        />
      </ResizablePanel>
    </ResizablePanelGroup>
  )
}
